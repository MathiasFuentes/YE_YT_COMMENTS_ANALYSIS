<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kanye Sentiment Dashboard</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --card-bg: #1e293b;
      --text: #e5e7eb;
      --text-muted: #94a3b8;
      --border: #334155;
      --c-pos: #22c55e;
      --c-neg: #ef4444;
      --c-neu: #64748b;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 24px;
    }
    section {
      margin-bottom: 24px;
    }
    .card {
      background-color: var(--card-bg);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid var(--border);
    }
    .title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header {
      border-bottom: 1px solid var(--border);
      padding-bottom: 16px;
      margin-bottom: 24px;
    }
    .header h1 {
      margin: 0;
      font-size: 1.75rem;
    }
    .header .subtitle {
      font-size: 1rem;
      color: var(--text-muted);
    }
    .kpi {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 24px;
    }
    .kpi .v {
      font-size: 2.25rem;
      font-weight: 700;
      white-space: nowrap;
    }
    .kpi .muted {
      color: var(--text-muted);
      font-size: 0.875rem;
      margin-bottom: 4px;
    }
    #k_nss.pos { color: var(--c-pos); }
    #k_nss.neg { color: var(--c-neg); }
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }
    
    .chart-caption {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
      margin-top: 12px;
    }
    .chart-caption code {
      background-color: var(--bg);
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 0.75rem;
    }
    .pie-container {
      max-height: 300px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #eventCheckboxesContainer {
      display: flex;
      flex-direction: column;
      max-height: 300px;
      overflow-y: auto;
      padding: 5px;
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    #eventCheckboxesContainer label {
      display: block;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 0.875rem;
      cursor: pointer;
    }
    #eventCheckboxesContainer label:hover {
      background-color: var(--bg);
    }
    #eventCheckboxesContainer input {
      margin-right: 8px;
    }
    .top-comments-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }
    .top-comment-item {
      padding: 10px 12px;
      border-radius: 10px;
      background-color: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }
    .top-comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }
    .top-comment-author {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
    }
    .top-comment-likes {
      font-size: 0.8rem;
      color: var(--text-muted);
    }
    .top-comment-text {
      font-size: 0.85rem;
      color: var(--text);
      margin-bottom: 4px;
    }
    .top-comment-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }
    .top-comment-sentiment-pos { color: var(--c-pos); }
    .top-comment-sentiment-neg { color: var(--c-neg); }
    .top-comment-sentiment-neu { color: var(--c-neutral); }

    @media (max-width: 900px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>

  <header class="header">
    <h1 class="title">An√°lisis de Sentimiento de Comentarios sobre Kanye West</h1>
    <div class="subtitle">Dashboard interactivo con comentarios de Youtube.</div>
  </header>

  <section class="card kpi">
    <div>
      <div class="muted">Total</div>
      <div id="k_total" class="v">‚Äî</div>
    </div>
    <div>
      <div class="muted">Positivos</div>
      <div id="k_pos" class="v">‚Äî</div>
    </div>
    <div>
      <div class="muted">Negativos</div>
      <div id="k_neg" class="v">‚Äî</div>
    </div>
    <div>
      <div class="muted">Neutrales</div>
      <div id="k_neu" class="v">‚Äî</div>
    </div>
    <div>
      <div class="muted">Sentimiento Neto</div>
      <div id="k_nss" class="v">‚Äî</div>
    </div>
  </section>

  <section class="grid-2">
    <div class="card">
      <div class="title">Distribuci√≥n de Sentimiento</div>
      <canvas id="polarChart"></canvas>
      <div class="chart-caption">
        Datos de +80,000 comentarios. Sentimiento clasificado con un modelo roBERTa.
      </div>
    </div>
    <div class="card">
      <div class="title">An√°lisis de Tem√°ticas</div>
      <canvas id="topicsChart"></canvas>
      <div class="chart-caption">
        Tem√°ticas extra√≠das con un modelo Zero-Shot
      </div>
    </div>
  </section>
  
  <section class="grid-2">
    
    <div class="card">
    <div class="title">Comentarios con m√°s Likes</div>
    <div id="topCommentsList" class="top-comments-list"></div>
    <div class="chart-caption">
      Comentarios hist√≥ricos con mayor n√∫mero de Likes (solo YouTube).
    </div>
  </div>

    
    <div class="card">
      <div class="title">Evoluci√≥n Semestral de Sentimiento (%)</div>
      <canvas id="timelineChart"></canvas>
      <div class="chart-caption">
        Porcentaje de comentarios positivos, negativos y neutros por semestre (normalizado, solo YouTube).
      </div>
    </div>

  </section>


  <section class="card">
    <div class="title">Comparativa de Eventos Seleccionados</div>
    <div class="grid-2">
      <div>
        <div class="muted" style="margin-bottom: 8px;">Selecciona eventos para sumar sus datos (periodo de 30 d√≠as):</div>
        <div id="eventCheckboxesContainer">
          </div>
      </div>
      <div class="pie-container">
        <canvas id="eventComparatorPieChart"></canvas>
      </div>
    </div>
  </section>


  <script>
    // --- Configuraci√≥n Global ---
    const $ = (id) => document.getElementById(id);
    const API_BASE = "http://127.0.0.1:5000";
    const C_POS = '#22c55e';
    const C_NEG = '#ef4444';
    const C_NEU = '#64748b';
    const C_TEXT = '#e5e7eb';
    const C_MUTED_BG = '#334155';
    
    const C_LIKES = '#38bdf8'; 
    const C_REPLIES = '#94a3b8';
    
    const MAX_DATE_STR = '2025-10-23';
    const MIN_DATE_STR = '2020-10-24';
    
    const allEventsData = [
      { "event_date": "2020-10-24", "tag": "Joe Rogan Podcast #1554" },
      { "event_date": "2020-11-03", "tag": "Elecciones EE.UU. 2020" },
      { "event_date": "2020-11-04", "tag": "Kanye 2024" },
      { "event_date": "2021-08-05", "tag": "Evento Donda" },
      { "event_date": "2021-08-29", "tag": "Lanzamiento Donda" },
      { "event_date": "2022-02-22", "tag": "Lanzamiento Donda 2" },
      { "event_date": "2022-10-03", "tag": "Pol√©mica White Lives Matter" },
      { "event_date": "2022-10-09", "tag": "Comentarios antisemitas" },
      { "event_date": "2022-12-01", "tag": "Cena con Trump" },
      { "event_date": "2023-01-01", "tag": "Desaparici√≥n medi√°tica" },
      { "event_date": "2023-12-15", "tag": "Anuncio √°lbum Vultures" },
      { "event_date": "2024-02-09", "tag": "Lanzamiento √°lbum Vultures" },
      { "event_date": "2024-03-07", "tag": "Cancelaci√≥n de conciertos" },
      { "event_date": "2025-03-20", "tag": "Declaraciones pol√≠ticas" },
      { "event_date": "2025-08-12", "tag": "Candidatura 2028" }
    ];

    Chart.register(ChartDataLabels);
    if (window.ChartAnnotation && window.ChartAnnotation.id) {
      Chart.register(window.ChartAnnotation);
    } else {
      console.warn('El plugin ChartAnnotation no se pudo registrar.');
    }

    const polar = new Chart($('polarChart'), {
      type: 'doughnut',
      data: {
        labels: ['Positivo', 'Negativo', 'Neutro'],
        datasets: [{ data: [0, 0, 0], backgroundColor: [C_POS, C_NEG, C_NEU] }]
      },
      options: {
        cutout: '60%',
        responsive: true,
        aspectRatio: 2,
        plugins: {
          legend: { position: 'bottom', labels: { color: C_TEXT } },
          datalabels: {
            color: '#ffffff',
            font: { weight: 'bold', size: 14 },
            formatter: (value, ctx) => {
              const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
              const percentage = (value / total * 100);
              return percentage > 5 ? percentage.toFixed(1) + '%' : '';
            }
          }
        }
      }
    });

    const topicsChart = new Chart($('topicsChart'), {
      type: 'bar',
      data: {
        labels: [],
        datasets: [
          { label: 'Positivo', data: [], backgroundColor: C_POS },
          { label: 'Negativo', data: [], backgroundColor: C_NEG },
          { label: 'Neutro', data: [], backgroundColor: C_NEU }
        ]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        aspectRatio: 2, 
        scales: {
          x: { stacked: true, ticks: { color: C_TEXT }, grid: { color: 'rgba(255,255,200,0.06)' } },
          y: { stacked: true, ticks: { color: C_TEXT }, grid: { color: 'rgba(255,255,200,0.06)' } }
        },
        plugins: {
          legend: { position: 'bottom', labels: { color: C_TEXT } },
          datalabels: { display: false }
        }
      }
    });
    

    const eventComparatorPieChart = new Chart($('eventComparatorPieChart'), {
      type: 'pie',
      data: {
        labels: ['Sin selecci√≥n'],
        datasets: [{
          data: [1],
          backgroundColor: [C_MUTED_BG]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: C_TEXT }
          },
          datalabels: {
            color: '#ffffff',
            font: { weight: 'bold' },
            formatter: (value, ctx) => {
              if (ctx.chart.data.labels[0] === 'Sin selecci√≥n') return '';
              const total = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
              const percentage = (value / total * 100);
              return percentage > 5 ? percentage.toFixed(1) + '%' : '';
            }
          }
        }
      }
    });

    const timelineChart = new Chart($('timelineChart'), {
      type: 'line',
      type: 'line',
  data: {
    datasets: [
      {
        label: 'Positivo',
        data: [],
        borderColor: C_POS,
        backgroundColor: C_POS,
        parsing: { xAxisKey: 'date', yAxisKey: 'pos_percent' },
        tension: 0.1,
        pointRadius: 0
      },
      {
        label: 'Negativo',
        data: [],
        borderColor: C_NEG,
        backgroundColor: C_NEG,
        parsing: { xAxisKey: 'date', yAxisKey: 'neg_percent' },
        tension: 0.1,
        pointRadius: 0
      },
      {
        label: 'Neutro',
        data: [],
        borderColor: C_NEU,
        backgroundColor: C_NEU,
        parsing: { xAxisKey: 'date', yAxisKey: 'neu_percent' },
        tension: 0.1,
        pointRadius: 0
      }
    ]
      },
        options: {
      responsive: true,
      aspectRatio: 1.6,
      scales: {
        x: {
          type: 'time',
          time: {
            unit: 'year',           
            tooltipFormat: 'yyyy'   
          },
          ticks: { color: C_TEXT },
          grid: { color: 'rgba(255,255,255,0.06)' }
        },
        y: {
          beginAtZero: true,
          max: 100,
          title: { display: true, text: '% del Total Semestral', color: C_TEXT },
          ticks: {
            color: C_TEXT,
            callback: (value) => value + '%'
          },
          grid: { color: 'rgba(255,255,255,0.06)' }
        }
      },
      plugins: {
        legend: { position: 'bottom', labels: { color: C_TEXT } },
        datalabels: { display: false }
      }
    }
  });


    async function fetchJSON(url) {
      try {
        const resp = await fetch(url);
        if (!resp.ok) {
          console.error("Error fetching data:", resp.statusText);
          return null;
        }
        return await resp.json();
      } catch (err) {
        console.error("Fetch error:", err);
        return null;
      }
    }


    async function refresh() {
      const kpis = await fetchJSON(`${API_BASE}/kpis?from=${MIN_DATE_STR}&to=${MAX_DATE_STR}`);
      if (kpis) {
        updateKpis(kpis);
        updatePolarChart(kpis);
      }
      return kpis;
    }


    async function loadTopics() {
      const data = await fetchJSON(`${API_BASE}/topics?from=${MIN_DATE_STR}&to=${MAX_DATE_STR}`);
      if (!data) return;

      const labels = Object.keys(data);
      
      if (labels.length === 0) {
        topicsChart.data.labels = ["Sin datos"];
        topicsChart.data.datasets[0].data = [0,0,0];
        topicsChart.update();
        return;
      }
      
      labels.sort((a, b) => {
        const totalA = (data[a].pos || 0) + (data[a].neg || 0) + (data[a].neu || 0);
        const totalB = (data[b].pos || 0) + (data[b].neg || 0) + (data[b].neu || 0);
        return totalB - totalA;
      });

      const posData = labels.map(label => data[label].pos || 0);
      const negData = labels.map(label => data[label].neg || 0);
      const neuData = labels.map(label => data[label].neu || 0);

      topicsChart.data.labels = labels;
      topicsChart.data.datasets[0].data = posData;
      topicsChart.data.datasets[1].data = negData;
      topicsChart.data.datasets[2].data = neuData;
      topicsChart.update();
    }

    async function loadTimeline() {
    const data = await fetchJSON(
      `${API_BASE}/sentiment_timeline?from=${MIN_DATE_STR}&to=${MAX_DATE_STR}`
    );
    if (!data || !Array.isArray(data) || data.length === 0) {
      console.warn('Timeline vac√≠o o con error:', data);
      return;
    }

    console.log('sentiment_timeline data:', data);
    timelineChart.data.datasets[0].data = data;
    timelineChart.data.datasets[1].data = data;
    timelineChart.data.datasets[2].data = data;
    timelineChart.update();
  }



    
    function renderEventComparator() {
      const container = $('eventCheckboxesContainer');
      
      allEventsData.forEach((event, i) => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.name = 'event_comparator';
        checkbox.value = event.event_date;
        checkbox.id = `chk-${i}`;
        checkbox.dataset.tag = event.tag;
        
        checkbox.addEventListener('change', updateEventComparatorChart);
        
        label.htmlFor = checkbox.id;
        label.title = event.title;
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(event.tag));
        
        container.appendChild(label);
      });
    }

    async function updateEventComparatorChart() {
      const checkedEvents = document.querySelectorAll('#eventCheckboxesContainer input:checked');
      const maxDate = luxon.DateTime.fromISO(MAX_DATE_STR);

      if (checkedEvents.length === 0) {
        eventComparatorPieChart.data.labels = ['Sin selecci√≥n'];
        eventComparatorPieChart.data.datasets[0].data = [1];
        eventComparatorPieChart.data.datasets[0].backgroundColor = [C_MUTED_BG];
        eventComparatorPieChart.update();
        return;
      }
      

      let totalPos = 0;
      let totalNeg = 0;
      let totalNeu = 0;
      
      const kpisPromises = [];
      
      checkedEvents.forEach(checkbox => {
        const {from, to} = getEventDateRange(checkbox.value, maxDate);
        kpisPromises.push(fetchJSON(`${API_BASE}/kpis?from=${from}&to=${to}`));
      });
      

      const kpisResults = await Promise.all(kpisPromises);
      

      kpisResults.forEach(kpis => {
        if (kpis) {
          totalPos += (kpis.total_pos || 0);
          totalNeg += (kpis.total_neg || 0);
          totalNeu += (kpis.total_neu || 0);
        }
      });
      
      eventComparatorPieChart.data.labels = ['Positivo', 'Negativo', 'Neutro'];
      eventComparatorPieChart.data.datasets[0].data = [totalPos, totalNeg, totalNeu];
      eventComparatorPieChart.data.datasets[0].backgroundColor = [C_POS, C_NEG, C_NEU];
      eventComparatorPieChart.update();
    }
    
    
    function getEventDateRange(eventDateStr, maxDate) {
      const startDate = luxon.DateTime.fromISO(eventDateStr);
      const endDate = startDate.plus({ days: 30 });
      const finalEndDate = endDate > maxDate ? maxDate : endDate;
      return {
        from: startDate.toISODate(),
        to: finalEndDate.toISODate()
      };
    }

    function escapeHtml(str) {
    if (!str) return '';
    return str
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
  }

  


    // --- Funciones de Actualizaci√≥n de UI (Principales) ---

    function updateKpis(kpis) {
      const total = kpis.total_comments || 0;
      $('k_total').textContent = total.toLocaleString('es-ES');
      $('k_pos').textContent = (kpis.total_pos || 0).toLocaleString('es-ES');
      $('k_neg').textContent = (kpis.total_neg || 0).toLocaleString('es-ES');
      $('k_neu').textContent = (kpis.total_neu || 0).toLocaleString('es-ES');

      const nss = total > 0 ? ((kpis.total_pos || 0) - (kpis.total_neg || 0)) / total : 0;
      const nssPercent = (nss * 100).toFixed(1);
      $('k_nss').textContent = (nss > 0 ? '+' : '') + nssPercent + '%';
      $('k_nss').className = nss > 0 ? 'v pos' : 'v neg';
    }

    function updatePolarChart(kpis) {
      polar.data.datasets[0].data[0] = kpis.total_pos || 0;
      polar.data.datasets[0].data[1] = kpis.total_neg || 0;
      polar.data.datasets[0].data[2] = kpis.total_neu || 0;
      polar.update();
    }

    async function loadTopComments() {
    const url = `${API_BASE}/top_comments?from=${MIN_DATE_STR}&to=${MAX_DATE_STR}&limit=5`;
    const data = await fetchJSON(url);
    if (!data || !Array.isArray(data) || data.length === 0) {
      console.warn('No hay top comments', data);
      return;
    }

    const container = document.getElementById('topCommentsList');
    container.innerHTML = '';

    data.forEach(c => {
      const item = document.createElement('div');
      item.className = 'top-comment-item';

      const sentimentClass =
        c.sentiment_label === 'pos' ? 'top-comment-sentiment-pos' :
        c.sentiment_label === 'neg' ? 'top-comment-sentiment-neg' :
        c.sentiment_label === 'neu' ? 'top-comment-sentiment-neu' : '';

      const dateStr = c.created_at ? String(c.created_at).slice(0, 10) : '';

      item.innerHTML = `
        <div class="top-comment-header">
          <span class="top-comment-author">${escapeHtml(c.author || 'An√≥nimo')}</span>
          <span class="top-comment-likes">‚ù§ ${c.like_count ?? 0}</span>
        </div>
        <div class="top-comment-text">${escapeHtml(c.text || '')}</div>
        <div class="top-comment-meta">
          <span>${dateStr}</span>
          ${c.sentiment_label ? `<span class="${sentimentClass}">${c.sentiment_label}</span>` : ''}
        </div>
      `;

      container.appendChild(item);
    });
  }

    (async () => {
      await refresh();
      await loadTopics();
      await loadTimeline();
      await loadTopComments();
      renderEventComparator();
    })();
  </script>
</body>
</html>